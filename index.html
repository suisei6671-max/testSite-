<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>コメント一覧</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      background-color: #f9f9f9;
    }
    .form-buttons {
      margin-bottom: 2em;
    }
    .form-buttons button {
      background-color: #4CAF50;
      color: white;
      padding: 0.6em 1.2em;
      margin-right: 1em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
    }
    .form-buttons button:hover {
      background-color: #45a049;
    }
    .comment {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1em;
      margin-bottom: 1em;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.05);
    }
    .meta {
      display: flex;
      align-items: center;
      margin-bottom: 0.5em;
    }
    .meta img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 0.5em;
    }
    .timestamp {
      color: #888;
      font-size: 0.9em;
      margin-left: auto;
      cursor: pointer;
      text-decoration: underline dotted;
    }
    .timestamp:hover {
      color: #333;
    }
    .replies {
      margin-left: 2em;
      border-left: 2px solid #ccc;
      padding-left: 1em;
      margin-top: 1em;
    }
    .reply-link {
      color: #d35400;
      font-weight: bold;
    }
    .reply-link:hover {
      text-decoration: underline;
    }
    a {
      color: #1a73e8;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>公開コメント一覧</h1>

  <div class="form-buttons">
    <button onclick="loadComments()">更新する</button>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSc2WgysDW59THAeJLVBIiuQc0C7eQburcoH1pQTn938jxT7qA/viewform" target="_blank">
      <button>コメントを投稿する</button>
    </a>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLScM8_8w1laH6ZmkXFiCt-E2YAMXPA3aAVWrMB2iOYaaVyqOsA/viewform" target="_blank">
      <button>ユーザー登録する</button>
    </a>
  </div>

  <div id="comments">読み込み中...</div>

  <script>
    const apiURL = "https://script.google.com/macros/s/AKfycbzWAs49E9VuoLZMDjFQaPdipuwPf2UFl2V8ughkY1pkqfrwxkjKOVuF-axogdJUaft9fQ/exec";

    function formatTimestamp(isoString) {
      const date = new Date(isoString);
      const jst = new Date(date.getTime() + 9 * 60 * 60 * 1000);
      const yyyy = jst.getFullYear();
      const mm = String(jst.getMonth() + 1).padStart(2, '0');
      const dd = String(jst.getDate()).padStart(2, '0');
      const hh = String(jst.getHours()).padStart(2, '0');
      const mi = String(jst.getMinutes()).padStart(2, '0');
      return `${yyyy}/${mm}/${dd} ${hh}:${mi}`;
    }

    function linkifyContent(text) {
      return text
        .replace(/##(\d+)/g, '<a href="#comment-$1" class="reply-link">>>#$1</a>')
        .replace(/#(\d+)/g, '<a href="#comment-$1">#$1</a>');
    }

    function copyCommentID(id) {
      const text = `#${id}`;
      navigator.clipboard.writeText(text).then(() => {
        alert(`${text} をコピーしました！`);
      }).catch(err => {
        alert("コピーに失敗しました: " + err);
      });
    }

    function groupComments(data) {
      const commentsById = {};
      const roots = [];
    
      // すべてのコメントを登録（キーは文字列）
      data.forEach(entry => {
        commentsById[String(entry.id)] = { ...entry, replies: [] };
      });
    
      // 返信関係を構築
      data.forEach(entry => {
        const match = entry.content.match(/^##(\d+)/);
        if (match) {
          const parentId = match[1]; // ← 数値じゃなく文字列のまま！
          const parent = commentsById[parentId];
          if (parent) {
            parent.replies.push(commentsById[String(entry.id)]);
          } else {
            roots.push(commentsById[String(entry.id)]);
          }
        } else {
          roots.push(commentsById[String(entry.id)]);
        }
      });
    
      return roots;
    }


    function renderComment(entry) {
      const div = document.createElement("div");
      div.className = "comment";
      div.id = `comment-${entry.id}`;

      const iconHTML = entry.icon
        ? `<img src="${entry.icon}" alt="icon">`
        : "";

      div.innerHTML = `
        <div class="meta">
          ${iconHTML}
          <strong>${entry.username}</strong>
          <span class="timestamp" onclick="copyCommentID(${entry.id})" title="クリックでコピー">#${entry.id} ${formatTimestamp(entry.timestamp)}</span>
        </div>
        <div><strong>スレッド:</strong> ${entry.thread}</div>
        <div><strong>内容:</strong><br>${linkifyContent(entry.content || "")}</div>
      `;

      if (entry.replies && entry.replies.length > 0) {
        const repliesDiv = document.createElement("div");
        repliesDiv.className = "replies";
        entry.replies.forEach(reply => {
          repliesDiv.appendChild(renderComment(reply));
        });
        div.appendChild(repliesDiv);
      }

      return div;
    }

    function loadComments() {
      const container = document.getElementById("comments");
      container.innerHTML = "読み込み中...";

      fetch(apiURL)
        .then(res => res.json())
        .then(data => {
          if (data.length === 0) {
            container.innerHTML = "<p>公開コメントはまだありません。</p>";
            return;
          }

          container.innerHTML = "";
          const grouped = groupComments(data.reverse());
          grouped.forEach(entry => {
            container.appendChild(renderComment(entry));
          });
        })
        .catch(err => {
          container.textContent = "読み込みエラー: " + err;
        });
    }

    window.addEventListener("DOMContentLoaded", loadComments);
  </script>
</body>
</html>
